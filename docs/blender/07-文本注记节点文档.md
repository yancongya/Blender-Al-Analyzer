# 文本注记节点文档

## 节点信息

| 属性 | 值 |
|------|-----|
| 类名 | `AINodeTextNote` |
| 标签 | "Note" |
| 图标 | `TEXT` |
| 类型 | 自定义节点 |

## 节点功能

在 Blender 节点编辑器中创建文本注记节点，用于：
- 添加注释和说明
- 显示文本内容
- 自定义颜色
- 自动调整宽度

## 代码位置

`backend/ai_note.py` 第 1-200 行

## 节点属性

### text_name

**类型**：StringProperty

**描述**：关联的文本块名称

```python
text_name: _bp.StringProperty()
```

### ui_color

**类型**：FloatVectorProperty

**描述**：节点颜色

**默认值**：(0.0, 0.0, 0.0)

**范围**：0.0 - 1.0

```python
def get_ui_color(self):
    return self.color

def set_ui_color(self, value):
    self.color = value
    self.use_custom_color = True

ui_color: _bp.FloatVectorProperty(
    name="Color", 
    subtype='COLOR', 
    default=(0.0, 0.0, 0.0), 
    min=0.0, 
    max=1.0, 
    get=get_ui_color, 
    set=set_ui_color
)
```

## 节点方法

### init(self, context)

**功能**：初始化节点

**行为**：
- 设置节点宽度为 200
- 启用自定义颜色
- 从偏好设置获取默认颜色

**代码位置**：`backend/ai_note.py` 第 20-30 行

```python
def init(self, context):
    self.width = 200
    self.use_custom_color = True
    prefs = get_preferences()
    if prefs:
        try:
            self.color = prefs.default_color
        except Exception:
            pass
```

### get_char_width(self, ch)

**功能**：获取字符宽度

**参数**：
- `ch`: 字符

**返回**：字符宽度（像素）

**代码位置**：`backend/ai_note.py` 第 32-62 行

```python
def get_char_width(self, ch):
    w = 7.5
    code = ord(ch)
    if code < 128:
        if ch in "il1.,'|:;!I()[] ":
            w = 4.0
        elif ch in "mwMW@%_":
            w = 10.0
        elif ch.isupper() or ch.isdigit():
            w = 8.2
        else:
            w = 5.5
    else:
        w = 11.0
    return w * 1.03
```

### smart_wrap_text(self, text, max_width_px)

**功能**：智能换行

**参数**：
- `text`: 文本内容
- `max_width_px`: 最大宽度（像素）

**返回**：换行后的文本行列表

**代码位置**：`backend/ai_note.py` 第 64-90 行

```python
def smart_wrap_text(self, text, max_width_px):
    lines = []
    padding = 20
    limit = max(20, max_width_px - padding)
    paragraphs = text.splitlines()
    for paragraph in paragraphs:
        if not paragraph:
            lines.append("")
            continue
        current_line = ""
        current_width = 0
        for char in paragraph:
            w = self.get_char_width(char)
            if current_width + w > limit:
                if current_line:
                    lines.append(current_line)
                current_line = char
                current_width = w
            else:
                current_line += char
                current_width += w
        if current_line:
            lines.append(current_line)
    return lines
```

### draw_buttons(self, context, layout)

**功能**：绘制节点按钮

**行为**：
- 显示 Open、Fit、Paste 按钮
- 显示文本内容
- 自动换行
- 限制显示行数（最多 100 行）

**代码位置**：`backend/ai_note.py` 第 92-120 行

```python
def draw_buttons(self, context, layout):
    txt = bpy.data.texts.get(self.text_name)
    row = layout.row(align=True)
    row.operator("ainode.open_editor", text="Open")
    row.operator("ainode.fit_width", text="Fit")
    row.operator("ainode.paste_clipboard", text="Paste")
    
    if not txt:
        layout.label(text="[Empty]")
        return
    
    if not txt.use_fake_user:
        txt.use_fake_user = True
    
    raw_text = txt.as_string()
    if not raw_text.strip():
        layout.label(text="[Empty]")
    else:
        lines = self.smart_wrap_text(raw_text, self.width)
        col = layout.column(align=True)
        col.scale_y = 0.9
        for i, line in enumerate(lines):
            if i > 100:
                sub = col.column(align=True)
                sub.scale_y = 1.0
                sub.label(text="... (Text too long)")
                break
            display_text = line if line != "" else " "
            col.label(text=display_text, translate=False)
```

### copy(self, node)

**功能**：复制节点

**行为**：清空 `text_name`

**代码位置**：`backend/ai_note.py` 第 122-124 行

```python
def copy(self, node):
    self.text_name = ""
```

### free(self)

**功能**：释放节点

**行为**：
- 移除文本块的 fake_user 标记

**代码位置**：`backend/ai_note.py` 第 126-131 行

```python
def free(self):
    if self.text_name:
        txt = bpy.data.texts.get(self.text_name)
        if txt:
            txt.use_fake_user = False
```

## 偏好设置

### AINODE_Preferences

**代码位置**：`backend/ai_note.py` 第 134-144 行

**属性**：

| 属性 | 类型 | 默认值 | 范围 | 描述 |
|------|------|--------|------|------|
| `editor_width` | Int | 600 | 200-1600 | 编辑器宽度 |
| `editor_height` | Int | 500 | 200-1200 | 编辑器高度 |
| `default_color` | FloatVector | (0.0, 0.0, 0.0) | 0.0-1.0 | 默认颜色 |

**代码**：
```python
class AINODE_Preferences(AddonPreferences):
    bl_idname = 'ainode'
    editor_width: _bp.IntProperty(default=600, min=200, max=1600)
    editor_height: _bp.IntProperty(default=500, min=200, max=1200)
    default_color: _bp.FloatVectorProperty(subtype='COLOR', default=(0.0, 0.0, 0.0), min=0.0, max=1.0)
    
    def draw(self, context):
        layout = self.layout
        layout.prop(self, "editor_width", text="Editor Width")
        layout.prop(self, "editor_height", text="Editor Height")
        layout.prop(self, "default_color", text="Default Color")
```

## 运算符

### AINODE_OT_open_editor

**类名**：`AINODE_OT_open_editor`

**功能**：打开文本编辑器

**代码位置**：`backend/ai_note.py` 第 146-180 行

---

### AINODE_OT_close_window

**类名**：`AINODE_OT_close_window`

**功能**：关闭窗口

**代码位置**：`backend/ai_note.py` 第 183-197 行

---

### AINODE_OT_paste_clipboard

**类名**：`AINODE_OT_paste_clipboard`

**功能**：从剪贴板粘贴

**代码位置**：`backend/ai_note.py` 第 200-230 行

---

### AINODE_OT_fit_width

**类名**：`AINODE_OT_fit_width`

**功能**：自动调整宽度

**代码位置**：`backend/ai_note.py` 第 233-262 行

---

### AINODE_PT_note_panel

**类名**：`AINODE_PT_note_panel`

**功能**：注记面板

**代码位置**：`backend/ai_note.py` 第 265-278 行

---

## 工具函数

### get_preferences()

**功能**：获取偏好设置

**返回**：偏好设置对象

**代码位置**：`backend/ai_note.py` 第 232-239 行

```python
def get_preferences():
    try:
        return bpy.context.preferences.addons.get('ainode').preferences
    except Exception:
        return None
```

---

### _compute_width(text)

**功能**：计算文本宽度

**参数**：
- `text`: 文本内容

**返回**：文本宽度（像素）

**代码位置**：`backend/ai_note.py` 第 242-262 行

```python
def _compute_width(text):
    def w(ch):
        v = 7.5
        c = ord(ch)
        if c < 128:
            if ch in "il1.,'|:;!I()[] ":
                v = 4.0
            elif ch in "mwMW@%_":
                v = 10.0
            elif ch.isupper() or ch.isdigit():
                v = 8.2
            else:
                v = 5.5
        else:
            v = 11.0
        return v * 1.03
    
    m = 0
    for line in (text.splitlines() or [text]):
        cur = 0
        for ch in line:
            cur += w(ch)
        if cur > m:
            m = cur
    return max(100, int(m) + 15)
```

---

### _get_tree_and_space()

**功能**：获取节点树和空间

**返回**：(tree, space, area)

**代码位置**：`backend/ai_note.py` 第 265-278 行

```python
def _get_tree_and_space():
    ctx = bpy.context
    area = None
    for a in ctx.screen.areas:
        if a.type == 'NODE_EDITOR':
            area = a
            break
    space = None
    tree = None
    if area:
        for s in area.spaces:
            if s.type == 'NODE_EDITOR':
                space = s
                break
    if space:
        tree = space.edit_tree
    if not tree and hasattr(ctx, 'space_data') and getattr(ctx.space_data, 'type', '') == 'NODE_EDITOR':
        tree = ctx.space_data.edit_tree
        space = ctx.space_data
    return tree, space, area
```

---

### create_note(text)

**功能**：创建文本注记节点

**参数**：
- `text`: 文本内容

**返回**：是否成功创建

**代码位置**：`backend/ai_note.py` 第 280-310 行

```python
def create_note(text):
    ensure_registered()
    tree, space, area = _get_tree_and_space()
    if not tree:
        return False
    try:
        node = tree.nodes.new('AINodeTextNote')
    except Exception:
        return False
    node.label = '注记'
    try:
        txt_block = bpy.data.texts.new(name='注记')
    except Exception:
        txt_block = None
    if txt_block:
        txt_block.use_fake_user = True
        txt_block.from_string(text)
        node.text_name = txt_block.name
    return True
```

---

### ensure_registered()

**功能**：确保类已注册

**代码位置**：`backend/ai_note.py` 第 313-335 行

```python
def ensure_registered():
    try:
        if not hasattr(bpy.types, 'AINodeTextNote'):
            _bu.register_class(AINodeTextNote)
        if not hasattr(bpy.types, 'AINODE_Preferences'):
            _bu.register_class(AINODE_Preferences)
        # Operators and Panel
        if not hasattr(bpy.types, 'AINODE_OT_open_editor'):
            _bu.register_class(AINODE_OT_open_editor)
        if not hasattr(bpy.types, 'AINODE_OT_close_window'):
            _bu.register_class(AINODE_OT_close_window)
        if not hasattr(bpy.types, 'AINODE_OT_paste_clipboard'):
            _bu.register_class(AINODE_OT_paste_clipboard)
        if not hasattr(bpy.types, 'AINODE_OT_fit_width'):
            _bu.register_class(AINODE_OT_fit_width)
        if not hasattr(bpy.types, 'AINODE_PT_note_panel'):
            _bu.register_class(AINODE_PT_note_panel)
        ensure_keymap()
    except Exception:
        pass
```

---

## 使用示例

### 示例 1：创建文本注记节点

```python
import bpy
from backend.ai_note import create_note

# 创建文本注记节点
success = create_note("这是一个文本注记节点")
if success:
    print("文本注记节点创建成功")
else:
    print("文本注记节点创建失败")
```

### 示例 2：通过 Python API 创建

```python
import bpy

# 获取节点编辑器
tree = bpy.context.space_data.node_tree

# 创建文本注记节点
node = tree.nodes.new('AINodeTextNote')
node.label = "我的注记"
node.location = (0, 0)

# 创建文本块
txt_block = bpy.data.texts.new(name="我的注记")
txt_block.from_string("这是注记内容")
node.text_name = txt_block.name
```

### 示例 3：自定义颜色

```python
import bpy

# 获取文本注记节点
node = bpy.context.space_data.node_tree.nodes.get("Note")

# 设置颜色（RGB）
node.ui_color = (0.2, 0.6, 1.0)  # 蓝色
```

---

## 注意事项

1. **文本块管理**：文本块会自动设置 `use_fake_user = True`，以防止被删除
2. **宽度限制**：节点宽度会根据文本内容自动调整，最小宽度为 100 像素
3. **显示限制**：最多显示 100 行文本，超过部分会显示 "... (Text too long)"
4. **字符宽度**：不同字符有不同的宽度，中文字符宽度约为英文字符的 1.5 倍
5. **颜色范围**：颜色值为 0.0-1.0，对应 RGB 0-255

---

## 扩展功能

### 添加快捷键

```python
def ensure_keymap():
    wm = bpy.context.window_manager
    km = wm.keyconfigs.addon.keymaps.new(name='Node Editor', space_type='NODE_EDITOR')
    kmi = km.keymap_items.new('ainode.open_editor', 'D', 'PRESS', ctrl=True, shift=True)
    kmi.properties.text_name = ""
```

### 添加右键菜单

```python
def draw_ainode_menu(self, context):
    layout = self.layout
    layout.operator("ainode.paste_clipboard", text="粘贴注记")

bpy.types.NODE_MT_add.append(draw_ainode_menu)
```