# 右键菜单文档

## 菜单列表

| 菜单 | 类名 | 功能 |
|------|------|------|
| AI 节点分析器 | `AINodeAnalyzer_MT_context_menu` | 主右键菜单 |
| 问题（全部节点） | `AINodeAnalyzer_MT_question_options_all` | 全部节点问题选项子菜单 |
| 问题（无节点） | `AINodeAnalyzer_MT_question_options_none` | 无节点问题选项子菜单 |
| 问题（选中节点） | `AINodeAnalyzer_MT_question_options_selected` | 选中节点问题选项子菜单 |

## 1. AI 节点分析器菜单 (AINodeAnalyzer_MT_context_menu)

### 菜单信息

| 属性 | 值 |
|------|-----|
| 类名 | `AINodeAnalyzer_MT_context_menu` |
| 标签 | "AI节点分析器" |
| 类型 | `Menu` |

### 代码位置

`__init__.py` 第 4057-4095 行

```python
class AINodeAnalyzer_MT_context_menu(bpy.types.Menu):
    """AI Node Analyzer 右键菜单"""
    bl_label = "AI节点分析器"
    bl_idname = "AINODE_MT_context_menu"

    def draw(self, context):
        layout = self.layout
        scene = context.scene
        ain_settings = scene.ainode_analyzer_settings

        # 复制节点信息选项
        copy_row = layout.row(align=True)
        copy_op = copy_row.operator("node.copy_nodes_to_clipboard", text="复制节点", icon='COPY_ID')

        layout.separator()

        # 按照全选节点提问
        all_row = layout.row(align=True)
        all_op = all_row.operator("node.ask_ai_context", text="分析全部节点", icon='SELECT_EXTEND')
        all_op.node_scope = 'ALL'
        all_op.question_type = 'PRESET_SELECTOR'
        all_row.menu("AINODE_MT_question_options_all", text="", icon='TRIA_RIGHT')

        # 选择不使用节点进行提问
        layout.separator()
        none_row = layout.row(align=True)
        none_op = none_row.operator("node.ask_ai_context", text="不使用节点", icon='CANCEL')
        none_op.node_scope = 'NONE'
        none_op.question_type = 'PRESET_SELECTOR'
        none_row.menu("AINODE_MT_question_options_none", text="", icon='TRIA_RIGHT')

        # 按照所选的节点进行提问
        layout.separator()
        selected_row = layout.row(align=True)
        selected_op = selected_row.operator("node.ask_ai_context", text="分析选中节点", icon='NODE')
        selected_op.node_scope = 'SELECTED'
        selected_op.question_type = 'PRESET_SELECTOR'
        selected_row.menu("AINODE_MT_question_options_selected", text="", icon='TRIA_RIGHT')
```

### 菜单结构

```
┌─────────────────────────────────┐
│ AI 节点分析器                   │
├─────────────────────────────────┤
│ 📋 复制节点                     │
├─────────────────────────────────┤
│ 📊 分析全部节点      ▶          │
├─────────────────────────────────┤
│ ❌ 不使用节点        ▶          │
├─────────────────────────────────┤
│ 🔷 分析选中节点      ▶          │
└─────────────────────────────────┘
```

### 菜单项说明

| 菜单项 | 图标 | 功能 |
|--------|------|------|
| 复制节点 | `COPY_ID` | 复制节点信息到剪贴板（Alt+点击复制全部） |
| 分析全部节点 | `SELECT_EXTEND` | 分析当前节点树中的所有节点 |
| 不使用节点 | `CANCEL` | 不传递任何节点信息，仅基于问题进行回答 |
| 分析选中节点 | `NODE` | 仅分析当前选中的节点 |

### 相关运算符

| 运算符 | 功能 |
|--------|------|
| `node.copy_nodes_to_clipboard` | 复制节点信息到剪贴板 |
| `node.ask_ai_context` | AI 提问操作符 |

---

## 2. 问题（全部节点）菜单 (AINodeAnalyzer_MT_question_options_all)

### 菜单信息

| 属性 | 值 |
|------|-----|
| 类名 | `AINodeAnalyzer_MT_question_options_all` |
| 标签 | "问题" |
| 类型 | `Menu` |

### 代码位置

`__init__.py` 第 4098-4118 行

```python
class AINodeAnalyzer_MT_question_options_all(bpy.types.Menu):
    """AI Node Analyzer 问题选项子菜单 - 全部节点"""
    bl_label = "问题"
    bl_idname = "AINODE_MT_question_options_all"

    def draw(self, context):
        layout = self.layout
        scene = context.scene
        ain_settings = scene.ainode_analyzer_settings

        # 显示预设问题选项
        if default_question_presets_cache:
            for idx, preset in enumerate(default_question_presets_cache):
                label = preset.get('label', f'问题 {idx+1}')
                op_preset = layout.operator("node.ask_ai_context", text=label, icon='DOT')
                op_preset.node_scope = 'ALL'
                op_preset.question_type = 'PRESET'
                op_preset.question_index = idx

        # 添加手动输入问题选项
        manual_op = layout.operator("node.ask_ai_context", text="手动输入问题", icon='TEXT')
        manual_op.node_scope = 'ALL'
        manual_op.question_type = 'MANUAL'
```

### 菜单结构

```
┌─────────────────────────────────┐
│ 问题（全部节点）                 │
├─────────────────────────────────┤
│ ⚫ 预设问题 1                    │
│ ⚫ 预设问题 2                    │
│ ⚫ 预设问题 3                    │
│ ...                             │
├─────────────────────────────────┤
│ 📝 手动输入问题                  │
└─────────────────────────────────┘
```

### 菜单项说明

| 菜单项 | 图标 | 功能 |
|--------|------|------|
| 预设问题 N | `DOT` | 使用预设问题 N 分析全部节点 |
| 手动输入问题 | `TEXT` | 手动输入问题分析全部节点 |

---

## 3. 问题（无节点）菜单 (AINodeAnalyzer_MT_question_options_none)

### 菜单信息

| 属性 | 值 |
|------|-----|
| 类名 | `AINodeAnalyzer_MT_question_options_none` |
| 标签 | "问题" |
| 类型 | `Menu` |

### 代码位置

`__init__.py` 第 4121-4141 行

```python
class AINodeAnalyzer_MT_question_options_none(bpy.types.Menu):
    """AI Node Analyzer 问题选项子菜单 - 无节点"""
    bl_label = "问题"
    bl_idname = "AINODE_MT_question_options_none"

    def draw(self, context):
        layout = self.layout
        scene = context.scene
        ain_settings = scene.ainode_analyzer_settings

        # 显示预设问题选项
        if default_question_presets_cache:
            for idx, preset in enumerate(default_question_presets_cache):
                label = preset.get('label', f'问题 {idx+1}')
                op_preset = layout.operator("node.ask_ai_context", text=label, icon='DOT')
                op_preset.node_scope = 'NONE'
                op_preset.question_type = 'PRESET'
                op_preset.question_index = idx

        # 添加手动输入问题选项
        manual_op = layout.operator("node.ask_ai_context", text="手动输入问题", icon='TEXT')
        manual_op.node_scope = 'NONE'
        manual_op.question_type = 'MANUAL'
```

### 菜单结构

```
┌─────────────────────────────────┐
│ 问题（无节点）                   │
├─────────────────────────────────┤
│ ⚫ 预设问题 1                    │
│ ⚫ 预设问题 2                    │
│ ⚫ 预设问题 3                    │
│ ...                             │
├─────────────────────────────────┤
│ 📝 手动输入问题                  │
└─────────────────────────────────┘
```

### 菜单项说明

| 菜单项 | 图标 | 功能 |
|--------|------|------|
| 预设问题 N | `DOT` | 使用预设问题 N 进行回答（不使用节点） |
| 手动输入问题 | `TEXT` | 手动输入问题进行回答（不使用节点） |

---

## 4. 问题（选中节点）菜单 (AINodeAnalyzer_MT_question_options_selected)

### 菜单信息

| 属性 | 值 |
|------|-----|
| 类名 | `AINodeAnalyzer_MT_question_options_selected` |
| 标签 | "问题" |
| 类型 | `Menu` |

### 代码位置

`__init__.py` 第 4144-4164 行

```python
class AINodeAnalyzer_MT_question_options_selected(bpy.types.Menu):
    """AI Node Analyzer 问题选项子菜单 - 选中节点"""
    bl_label = "问题"
    bl_idname = "AINODE_MT_question_options_selected"

    def draw(self, context):
        layout = self.layout
        scene = context.scene
        ain_settings = scene.ainode_analyzer_settings

        # 显示预设问题选项
        if default_question_presets_cache:
            for idx, preset in enumerate(default_question_presets_cache):
                label = preset.get('label', f'问题 {idx+1}')
                op_preset = layout.operator("node.ask_ai_context", text=label, icon='DOT')
                op_preset.node_scope = 'SELECTED'
                op_preset.question_type = 'PRESET'
                op_preset.question_index = idx

        # 添加手动输入问题选项
        manual_op = layout.operator("node.ask_ai_context", text="手动输入问题", icon='TEXT')
        manual_op.node_scope = 'SELECTED'
        manual_op.question_type = 'MANUAL'
```

### 菜单结构

```
┌─────────────────────────────────┐
│ 问题（选中节点）                 │
├─────────────────────────────────┤
│ ⚫ 预设问题 1                    │
│ ⚫ 预设问题 2                    │
│ ⚫ 预设问题 3                    │
│ ...                             │
├─────────────────────────────────┤
│ 📝 手动输入问题                  │
└─────────────────────────────────┘
```

### 菜单项说明

| 菜单项 | 图标 | 功能 |
|--------|------|------|
| 预设问题 N | `DOT` | 使用预设问题 N 分析选中节点 |
| 手动输入问题 | `TEXT` | 手动输入问题分析选中节点 |

---

## 菜单注册

### 代码位置

`__init__.py` 第 4520-4526 行

```python
# 添加右键菜单到节点编辑器
bpy.types.NODE_MT_context_menu.append(draw_ainode_menu)

def draw_ainode_menu(self, context):
    """在节点编辑器右键菜单中添加AI Node Analyzer选项"""
    if context.area.type == 'NODE_EDITOR':
        self.layout.menu(AINodeAnalyzer_MT_context_menu.bl_idname, icon='PLUGIN')
```

### 注销

```python
# 从节点编辑器移除右键菜单
bpy.types.NODE_MT_context_menu.remove(draw_ainode_menu)
```

---

## 使用示例

### 示例 1：复制选中节点信息

1. 在节点编辑器中右键点击
2. 选择 "AI 节点分析器" > "复制节点"
3. 节点信息已复制到剪贴板

### 示例 2：分析全部节点

1. 在节点编辑器中右键点击
2. 选择 "AI 节点分析器" > "分析全部节点" > 选择预设问题
3. AI 将分析节点树中的所有节点

### 示例 3：分析选中节点

1. 在节点编辑器中选择要分析的节点
2. 右键点击
3. 选择 "AI 节点分析器" > "分析选中节点" > 选择预设问题
4. AI 将分析选中的节点

### 示例 4：不使用节点进行提问

1. 在节点编辑器中右键点击
2. 选择 "AI 节点分析器" > "不使用节点" > 选择预设问题
3. AI 将仅基于问题进行回答

### 示例 5：手动输入问题

1. 在节点编辑器中选择要分析的节点（可选）
2. 右键点击
3. 选择 "AI 节点分析器" > "分析选中节点" > "手动输入问题"
4. 在弹出的对话框中输入问题
5. 点击 "确认"

---

## 相关运算符

| 运算符 | 功能 |
|--------|------|
| `node.copy_nodes_to_clipboard` | 复制节点信息到剪贴板 |
| `node.ask_ai_context` | AI 提问操作符 |

---

## 相关属性

| 属性 | 类型 | 描述 |
|------|------|------|
| `node_scope` | Enum | 节点范围（ALL/NONE/SELECTED） |
| `question_type` | String | 问题类型（MANUAL/PRESET） |
| `question_index` | Int | 预设问题索引 |

---

## 全局变量

| 变量 | 类型 | 描述 |
|------|------|------|
| `default_question_presets_cache` | List | 默认问题预设缓存 |