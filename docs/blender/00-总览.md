# AI Node Analyzer 插件总览

## 插件信息

| 属性 | 值 |
|------|-----|
| 名称 | AI Node Analyzer |
| 作者 | Assistant |
| 版本 | 1.0.0 |
| Blender 版本 | 4.2.0+ |
| 位置 | Node Editor > Sidebar > AI Node Analyzer |
| 类别 | Node |
| 描述 | 使用 AI 分析 Blender 节点结构，提供见解、优化或解释 |

## 插件目录结构

```
ainode/
├── __init__.py                    # 主入口文件（4648行）
├── config.json                    # 配置文件
├── config.example.json            # 配置示例文件
├── backend/                       # 后端服务器
│   ├── server.py                  # Flask 后端服务器
│   ├── ai_note.py                 # 文本注记节点
│   └── api/
│       └── blender_api.py         # Blender API
├── chatgpt-web/                   # Web 前端
│   ├── dist/                      # 构建输出
│   └── src/                       # 源代码
├── frontend/                      # 前端资源
├── nodes/                         # 节点定义（目前为空）
└── docs/                          # 文档
```

## 核心功能模块

### 1. 主入口文件 (`__init__.py`)

包含插件的核心逻辑：

- **插件基本信息** (bl_info)
- **全局变量和缓存**
  - `server_manager`: 后端服务器管理器
  - `deepseek_models_cache`: DeepSeek 模型缓存
  - `ollama_models_cache`: Ollama 模型缓存
  - `bigmodel_models_cache`: BigModel 模型缓存
  - `generic_models_cache`: 通用模型缓存
  - `system_message_presets_cache`: 系统消息预设缓存
  - `default_question_presets_cache`: 默认问题预设缓存
  - `provider_configs_cache`: 服务商配置缓存

- **工具函数**
  - `get_output_detail_instruction()`: 获取输出详细程度指令
  - `clean_markdown()`: 清理 Markdown 格式
  - `copy_to_clipboard()`: 复制文本到剪贴板
  - `filter_node_description()`: 过滤节点描述
  - `get_selected_nodes_description()`: 获取选中节点描述
  - `parse_node_tree_recursive()`: 递归解析节点树

- **属性组**
  - `AINodeAnalyzerSettings`: 插件设置属性组
  - `SelectedTextPartItem`: 选中的文本部分项

- **面板类**
  - `NODE_PT_ai_analyzer`: 主面板
  - `NODE_PT_quick_copy`: 快速复制面板
  - `AINodeAnalyzerPreferences`: 插件偏好设置
  - `AINODE_PT_question_input_popup`: 问题输入弹窗面板

- **运算符类 (Operators)**
  - AI 分析相关：`NODE_OT_analyze_with_ai`, `NODE_OT_ask_ai`
  - 配置管理：`NODE_OT_load_config_from_file`, `NODE_OT_save_config_to_file`, `NODE_OT_reset_settings`
  - 后端服务器：`NODE_OT_toggle_backend_server`, `NODE_OT_open_backend_webpage`
  - 模型管理：`NODE_OT_refresh_models`, `NODE_OT_select_model`, `NODE_OT_test_bigmodel_model`
  - 节点操作：`NODE_OT_copy_nodes_to_clipboard`, `NODE_OT_create_analysis_frame`
  - 文本操作：`NODE_OT_refresh_to_text`, `NODE_OT_clean_markdown_text`, `NODE_OT_copy_text_to_clipboard`
  - 状态控制：`NODE_OT_stop_ai_request`, `NODE_OT_test_provider_status`

- **菜单类**
  - `AINodeAnalyzer_MT_context_menu`: 右键菜单
  - `AINodeAnalyzer_MT_question_options_all`: 全部节点问题选项
  - `AINodeAnalyzer_MT_question_options_selected`: 选中节点问题选项
  - `AINodeAnalyzer_MT_question_options_none`: 无节点问题选项

### 2. 后端服务器 (`backend/`)

- **server.py**: Flask 后端服务器
  - 提供 Web 界面
  - API 端点
  - 数据管理

- **ai_note.py**: 文本注记节点
  - `AINodeTextNote`: 文本注记节点类
  - `AINODE_Preferences`: 偏好设置

### 3. Web 前端 (`chatgpt-web/`)

- Vue.js + Vite 构建的 Web 界面
- 与后端服务器通信
- 提供更友好的用户界面

## 支持的 AI 服务商

| 服务商 | 标识符 | 模型示例 |
|--------|--------|----------|
| DeepSeek | DEEPSEEK | deepseek-chat, deepseek-reasoner |
| Ollama | OLLAMA | llama2, mistral |
| BigModel (智谱AI) | BIGMODEL | glm-4, glm-4-flash |
| 通用 | GENERIC | 自定义 |

## 支持的节点类型

- 几何节点 (Geometry Nodes)
- 材质节点 (Shader Nodes)
- 合成节点 (Compositor Nodes)
- 纹理节点 (Texture Nodes)
- 环境节点 (World Nodes)

## 核心功能

### 1. AI 节点分析
- 选择节点后，使用 AI 分析节点结构
- 提供见解、优化建议或解释

### 2. 交互式问答
- 提出具体问题，AI 基于节点信息回答
- 支持预设问题
- 支持深度思考模式
- 支持联网检索

### 3. 节点信息管理
- 复制节点信息到剪贴板
- 创建分析框架
- 刷新节点数据到文本编辑器

### 4. 配置管理
- 从文件加载配置
- 保存配置到文件
- 重置默认设置

### 5. 后端服务器
- 启动/停止后端服务器
- 在浏览器中打开 Web 界面
- 与 Web 前端通信

### 6. 快速复制
- 快速复制输出详细程度提示词
- 快速复制系统提示词
- 快速复制用户问题
- 快速复制节点数据

## 文本块说明

插件会在 Blender 中创建以下文本块：

| 文本块名称 | 用途 |
|-----------|------|
| `00-原始节点数据` | 原始节点数据（不过滤） |
| `01-输出详细程度提示词` | 输出详细程度提示词 |
| `02-系统提示词` | 系统提示词（身份提示词） |
| `03-用户问题` | 用户问题 |
| `04-节点数据` | 过滤后的节点数据 |
| `AINodeRefreshContent` | 刷新内容 |
| `AINodeAnalysisResult` | AI 分析结果 |

## 配置文件

### config.json 结构

```json
{
  "port": 5000,
  "ai": {
    "provider": {
      "name": "DEEPSEEK",
      "model": "deepseek-chat"
    },
    "deepseek": {
      "api_key": "",
      "model": "deepseek-chat",
      "url": "https://api.deepseek.com",
      "models": []
    },
    "ollama": {
      "url": "http://localhost:11434",
      "model": "llama2",
      "models": []
    },
    "bigmodel": {
      "api_key": "",
      "model": "glm-4",
      "url": "https://open.bigmodel.cn/api/paas/v4",
      "models": []
    },
    "system_prompt": "您是Blender节点的专家。分析以下节点结构并提供见解、优化或解释。",
    "temperature": 0.7,
    "top_p": 1.0,
    "memory": {
      "enabled": true,
      "target_k": 4
    },
    "thinking": {
      "enabled": false
    },
    "system_message_presets": [],
    "default_question_presets": [],
    "output_detail_presets": {
      "simple": "请简要说明，不需要使用markdown格式，简单描述即可。",
      "medium": "请按常规方式回答，使用适当的markdown格式来组织内容。",
      "detailed": "请详细说明，使用图表、列表、代码块等markdown格式来清晰地表达内容。"
    },
    "output_detail_level": "medium"
  }
}
```

## 关键设置

### AINodeAnalyzerSettings 属性

| 属性名 | 类型 | 描述 |
|--------|------|------|
| `backend_port` | Int | 后端服务器端口 |
| `ai_provider` | Enum | AI 服务提供商 |
| `deepseek_api_key` | String | DeepSeek API 密钥 |
| `deepseek_url` | String | DeepSeek 服务地址 |
| `deepseek_model` | String | DeepSeek 模型 |
| `ollama_url` | String | Ollama 服务地址 |
| `ollama_model` | String | Ollama 模型 |
| `bigmodel_api_key` | String | BigModel API 密钥 |
| `bigmodel_url` | String | BigModel 服务地址 |
| `bigmodel_model` | String | BigModel 模型 |
| `system_prompt` | String | 系统提示 |
| `temperature` | Float | AI 响应随机性 |
| `top_p` | Float | 核采样阈值 |
| `enable_memory` | Bool | 启用记忆功能 |
| `memory_target_k` | Int | 记忆目标值 |
| `enable_thinking` | Bool | 启用深度思考模式 |
| `enable_web` | Bool | 允许联网检索 |
| `user_input` | String | 用户输入文本 |
| `output_detail_level` | Enum | 回答详细程度 |
| `node_detail_level` | Int | 节点精细度 |
| `simplified_ui` | Bool | 简化 UI 模式 |
| `show_help_text` | Bool | 显示帮助提示 |

## 文档索引

- [01-主面板文档](./01-主面板文档.md)
- [02-快速复制面板文档](./02-快速复制面板文档.md)
- [03-设置弹窗文档](./03-设置弹窗文档.md)
- [04-运算符文档](./04-运算符文档.md)
- [05-右键菜单文档](./05-右键菜单文档.md)
- [06-后端服务器文档](./06-后端服务器文档.md)
- [07-文本注记节点文档](./07-文本注记节点文档.md)