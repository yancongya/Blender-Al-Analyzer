# 运算符文档 (Operators)

## 运算符列表

| 运算符 | 类名 | 功能 |
|--------|------|------|
| 从文件加载配置 | `NODE_OT_load_config_from_file` | 从 config.json 加载配置 |
| 保存配置到文件 | `NODE_OT_save_config_to_file` | 保存当前配置到 config.json |
| 重置设置 | `NODE_OT_reset_settings` | 重置所有设置为默认值 |
| 切换后端服务器 | `NODE_OT_toggle_backend_server` | 启动或停止后端服务器 |
| 打开后端网页 | `NODE_OT_open_backend_webpage` | 在浏览器中打开后端网页界面 |
| 测试提供商连通性 | `NODE_OT_test_provider_status` | 测试当前 AI 服务商的连通性 |
| 测试提供商连通性（服务器未启动） | `NODE_OT_test_provider_status_disabled` | 提示后端服务器未启动 |
| 终止 AI 请求 | `NODE_OT_stop_ai_request` | 终止当前正在进行的 AI 请求 |
| 重置服务地址 | `NODE_OT_reset_provider_url` | 重置服务地址为默认值 |
| 刷新模型列表 | `NODE_OT_refresh_models` | 刷新可用模型列表 |
| 刷新模型列表（服务器未启动） | `NODE_OT_refresh_models_disabled` | 提示后端服务器未启动 |
| 清理 Markdown | `NODE_OT_clean_markdown_text` | 清理当前文本文档的 Markdown 格式 |
| 清空 API 密钥 | `NODE_OT_clear_api_key` | 清空当前 API 密钥 |
| 选择模型 | `NODE_OT_select_model` | 选择此模型作为当前模型 |
| 测试 BigModel 模型 | `NODE_OT_test_bigmodel_model` | 测试当前 BigModel 模型是否可用 |
| 复制节点信息到剪贴板 | `NODE_OT_copy_nodes_to_clipboard` | 复制节点信息到剪贴板 |
| 复制全部节点信息到剪贴板 | `NODE_OT_copy_all_nodes_to_clipboard` | 复制当前节点树中的全部节点信息 |
| 刷新到文本编辑器 | `NODE_OT_refresh_to_text` | 刷新节点数据到文本编辑器 |
| 显示完整预览 | `NODE_OT_show_full_preview` | 在文本编辑器中显示完整预览 |
| 设置默认问题 | `NODE_OT_set_default_question` | 设置默认问题 |
| 清除问题 | `NODE_OT_clear_question` | 清除问题 |
| 使用 AI 分析选中的节点 | `NODE_OT_analyze_with_ai` | 将选中的节点发送给 AI 进行分析 |
| 向 AI 询问节点问题 | `NODE_OT_ask_ai` | 关于选中节点提出具体问题 |
| 创建分析框架 | `NODE_OT_create_analysis_frame` | 将选中的节点加入框架以便确定分析范围 |
| 复制文本部分 | `NODE_OT_copy_text_part` | 切换文本部分选择 / 复制单个部分 |
| 复制选中文本 | `NODE_OT_copy_active_text` | 复制所有选中的文本部分 |
| 复制文本到剪贴板 | `NODE_OT_copy_text_to_clipboard` | 复制当前文本编辑器的内容到剪贴板 |
| AI 提问（右键菜单） | `NODE_OT_ask_ai_context` | 右键菜单 AI 提问操作符 |
| 确认问题输入 | `NODE_OT_confirm_question_input` | 确认问题输入 |
| 取消问题输入 | `NODE_OT_cancel_question_input` | 取消问题输入 |

## 1. 配置管理运算符

### 1.1 从文件加载配置 (NODE_OT_load_config_from_file)

**代码位置**：`__init__.py` 第 1389-1614 行

**功能**：从 `config.json` 文件加载配置到插件设置。

**加载的配置项**：
- 端口 (`port`)
- AI 服务商 (`ai.provider`)
- DeepSeek 配置 (`ai.deepseek`)
- Ollama 配置 (`ai.ollama`)
- BigModel 配置 (`ai.bigmodel`)
- 系统提示词 (`ai.system_prompt`)
- 温度 (`ai.temperature`)
- Top P (`ai.top_p`)
- 记忆功能 (`ai.memory`)
- 系统消息预设 (`system_message_presets`)
- 默认问题预设 (`default_question_presets`)
- 回答详细程度预设 (`output_detail_presets`)
- 回答详细程度 (`output_detail_level`)

**相关属性**：
- `backend_port`
- `ai_provider`
- `deepseek_url`, `deepseek_api_key`, `deepseek_model`
- `ollama_url`, `ollama_model`
- `bigmodel_url`, `bigmodel_api_key`, `bigmodel_model`
- `system_prompt`
- `temperature`, `top_p`
- `enable_memory`, `memory_target_k`
- `identity_key`, `identity_text`
- `default_question_preset`, `default_question`
- `prompt_simple`, `prompt_medium`, `prompt_detailed`
- `output_detail_level`

---

### 1.2 保存配置到文件 (NODE_OT_save_config_to_file)

**代码位置**：`__init__.py` 第 1617-1760 行

**功能**：保存当前插件设置到 `config.json` 文件。

**保存的配置项**：
- 端口 (`port`)
- AI 服务商 (`ai.provider`)
- DeepSeek 配置 (`ai.deepseek`)
- Ollama 配置 (`ai.ollama`)
- BigModel 配置 (`ai.bigmodel`)
- 系统提示词 (`ai.system_prompt`)
- 温度 (`ai.temperature`)
- Top P (`ai.top_p`)
- 记忆功能 (`ai.memory`)
- 系统消息预设 (`system_message_presets`)
- 默认问题预设 (`default_question_presets`)
- 回答详细程度预设 (`output_detail_presets`)
- 回答详细程度 (`output_detail_level`)

---

### 1.3 重置设置 (NODE_OT_reset_settings)

**代码位置**：`__init__.py` 第 2440-2470 行

**功能**：重置所有插件设置为默认值。

**重置的配置项**：
- `ai_provider` = 'DEEPSEEK'
- `deepseek_api_key` = ""
- `deepseek_url` = "https://api.deepseek.com"
- `deepseek_model` = 'deepseek-chat'
- `ollama_url` = "http://localhost:11434"
- `ollama_model` = "llama2"
- `system_prompt` = "您是Blender节点的专家。分析以下节点结构并提供见解、优化或解释。"
- `user_input` = ""
- `default_question` = "请分析这些节点的功能和优化建议"
- `identity_key` = ""
- `default_question_preset` = ""
- `generic_base_url` = ""
- `generic_api_key` = ""
- `generic_model` = ""
- `enable_backend` = False
- `backend_port` = 5000
- `enable_memory` = True
- `memory_target_k` = 4

---

## 2. 后端服务器运算符

### 2.1 切换后端服务器 (NODE_OT_toggle_backend_server)

**代码位置**：`__init__.py` 第 1763-1791 行

**功能**：启动或停止后端服务器。

**行为**：
- 如果服务器正在运行，则停止服务器
- 如果服务器未运行，则启动服务器
- 使用 `backend_port` 属性指定的端口

**相关属性**：
- `backend_port`
- `enable_backend`
- `current_status`

---

### 2.2 打开后端网页 (NODE_OT_open_backend_webpage)

**代码位置**：`__init__.py` 第 2795-2813 行

**功能**：在浏览器中打开后端网页界面。

**行为**：
- 如果服务器正在运行，在浏览器中打开 `http://127.0.0.1:port`
- 如果服务器未运行，提示用户先启动服务器

---

### 2.3 测试提供商连通性 (NODE_OT_test_provider_status)

**代码位置**：`__init__.py` 第 2816-2836 行

**功能**：测试当前 AI 服务商的连通性。

**行为**：
- 调用后端 `/api/provider-connectivity` API
- 更新 `status_connectivity` 属性
- 显示连通性测试结果

**相关属性**：
- `ai_provider`
- `status_connectivity`

---

### 2.4 测试提供商连通性（服务器未启动）(NODE_OT_test_provider_status_disabled)

**代码位置**：`__init__.py` 第 2839-2848 行

**功能**：提示后端服务器未启动。

**行为**：
- 显示警告信息："后端服务器未启动，请先启动后端服务器"

---

## 3. 模型管理运算符

### 3.1 重置服务地址 (NODE_OT_reset_provider_url)

**代码位置**：`__init__.py` 第 2851-2871 行

**功能**：重置服务地址为默认值。

**默认值**：
- DEEPSEEK: "https://api.deepseek.com"
- OLLAMA: "http://localhost:11434"
- BIGMODEL: "https://open.bigmodel.cn/api/paas/v4"
- 通用: ""

**相关属性**：
- `ai_provider`
- `deepseek_url`
- `ollama_url`
- `bigmodel_url`
- `generic_base_url`

---

### 3.2 刷新模型列表 (NODE_OT_refresh_models)

**代码位置**：`__init__.py` 第 2874-2967 行

**功能**：刷新可用模型列表。

**行为**：
- 调用后端 `/api/provider-list-models` API
- 更新相应的模型缓存
- 更新配置文件中的模型列表
- 如果当前模型不在列表中，设置第一个模型为当前模型

**相关属性**：
- `ai_provider`
- `deepseek_model`
- `ollama_model`
- `bigmodel_model`
- `generic_model`
- `status_model_fetch`

**全局变量**：
- `deepseek_models_cache`
- `ollama_models_cache`
- `bigmodel_models_cache`
- `generic_models_cache`

---

### 3.3 刷新模型列表（服务器未启动）(NODE_OT_refresh_models_disabled)

**代码位置**：`__init__.py` 第 2970-2979 行

**功能**：提示后端服务器未启动。

**行为**：
- 显示警告信息："后端服务器未启动，请先启动后端服务器"

---

### 3.4 选择模型 (NODE_OT_select_model)

**代码位置**：`__init__.py` 第 2473-2490 行

**功能**：选择此模型作为当前模型。

**参数**：
- `model_name`: 模型名称
- `provider`: 服务商

**行为**：
- 根据服务商设置相应的模型属性

---

### 3.5 测试 BigModel 模型 (NODE_OT_test_bigmodel_model)

**代码位置**：`__init__.py` 第 2493-2537 行

**功能**：测试当前 BigModel 模型是否可用。

**行为**：
- 检查当前服务商是否为 BIGMODEL
- 检查是否配置了 API 密钥
- 检查后端服务器是否运行
- 调用后端 `/api/test-bigmodel-api` API
- 显示测试结果

---

### 3.6 清空 API 密钥 (NODE_OT_clear_api_key)

**代码位置**：`__init__.py` 第 2540-2550 行

**功能**：清空当前 API 密钥。

**行为**：
- 清空所有 API 密钥属性

**相关属性**：
- `generic_api_key`
- `deepseek_api_key`
- `bigmodel_api_key`

---

## 4. 节点操作运算符

### 4.1 复制节点信息到剪贴板 (NODE_OT_copy_nodes_to_clipboard)

**代码位置**：`__init__.py` 第 2553-2677 行

**功能**：复制节点信息到剪贴板。

**行为**：
- 普通点击：复制选中节点的信息
- Alt + 点击：复制全部节点的信息
- 使用当前精细度设置过滤节点信息

**相关属性**：
- `filter_level`

---

### 4.2 复制全部节点信息到剪贴板 (NODE_OT_copy_all_nodes_to_clipboard)

**代码位置**：`__init__.py` 第 2680-2724 行

**功能**：复制当前节点树中的全部节点信息。

**行为**：
- 使用递归解析函数获取完整的节点树信息
- 使用当前精细度设置过滤节点信息
- 复制到剪贴板

**相关属性**：
- `filter_level`

---

### 4.3 创建分析框架 (NODE_OT_create_analysis_frame)

**代码位置**：`__init__.py` 第 2982-3089 行

**功能**：将选中的节点加入框架以便确定分析范围。

**行为**：
- 如果已存在框架，则移除框架并记录节点名称
- 如果不存在框架，则创建框架并加入选中的节点
- 记录节点名称到 `analysis_frame_node_names` 属性

**相关属性**：
- `analysis_frame_node_names`

---

## 5. 文本操作运算符

### 5.1 刷新到文本编辑器 (NODE_OT_refresh_to_text)

**代码位置**：`__init__.py` 第 3092-3273 行

**功能**：刷新节点数据到文本编辑器。

**行为**：
- 创建或更新 5 个文本块：
  - `00-原始节点数据`：原始节点数据（不过滤）
  - `01-输出详细程度提示词`：输出详细程度提示词
  - `02-系统提示词`：系统提示词（身份提示词）
  - `03-用户问题`：用户问题
  - `04-节点数据`：过滤后的节点数据
- 将内容推送到后端服务器

**相关属性**：
- `filter_level`
- `output_detail_level`
- `system_prompt`
- `user_input`
- `prompt_simple`, `prompt_medium`, `prompt_detailed`

---

### 5.2 显示完整预览 (NODE_OT_show_full_preview)

**代码位置**：`__init__.py` 第 3276-3318 行

**功能**：在文本编辑器中显示完整预览。

**行为**：
- 创建或更新 `AINodeFullPreview` 文本块
- 写入完整的预览内容

**相关属性**：
- `preview_content`

---

### 5.3 清理 Markdown (NODE_OT_clean_markdown_text)

**代码位置**：`__init__.py` 第 2755-2785 行

**功能**：清理当前文本文档的 Markdown 格式。

**行为**：
- 获取当前活动的文本块
- 调用后端 `/api/clean-markdown` API
- 更新文本块内容

---

### 5.4 复制文本到剪贴板 (NODE_OT_copy_text_to_clipboard)

**代码位置**：`__init__.py` 第 993-1019 行

**功能**：复制当前文本编辑器的内容到剪贴板。

**行为**：
- 获取当前活动的文本编辑器
- 复制内容到剪贴板

---

### 5.5 设置默认问题 (NODE_OT_set_default_question)

**代码位置**：`__init__.py` 第 2788-2793 行

**功能**：设置默认问题。

**行为**：
- 将 `default_question` 的值设置到 `user_input`

---

### 5.6 清除问题 (NODE_OT_clear_question)

**代码位置**：`__init__.py` 第 2796-2801 行

**功能**：清除问题。

**行为**：
- 清空 `user_input`

---

## 6. AI 分析运算符

### 6.1 使用 AI 分析选中的节点 (NODE_OT_analyze_with_ai)

**代码位置**：`__init__.py` 第 3321-3474 行

**功能**：将选中的节点发送给 AI 进行分析。

**行为**：
- 获取选中节点的描述
- 过滤节点信息
- 在后台线程中调用 AI API
- 将结果写入 `AINodeAnalysisResult` 文本块

**相关属性**：
- `filter_level`
- `system_prompt`
- `deepseek_api_key`, `deepseek_model`
- `ollama_url`, `ollama_model`
- `current_status`

---

### 6.2 向 AI 询问节点问题 (NODE_OT_ask_ai)

**代码位置**：`__init__.py` 第 3477-3778 行

**功能**：关于选中节点提出具体问题。

**行为**：
- 获取用户问题
- 获取选中节点的描述
- 过滤节点信息
- 在后台线程中调用后端 `/api/stream-analyze` API
- 流式接收 AI 回答
- 支持终止请求
- 将结果保存为注释节点

**相关属性**：
- `user_input`
- `filter_level`
- `output_detail_level`
- `system_prompt`
- `enable_thinking`
- `enable_memory`
- `memory_target_k`
- `ai_provider`
- `deepseek_model`, `ollama_model`, `bigmodel_model`, `generic_model`
- `ai_question_status`
- `can_terminate_request`
- `current_status`

**方法**：
- `perform_analysis()`: 执行 AI 分析
- `call_deepseek_api()`: 调用 DeepSeek API
- `call_ollama_api()`: 调用 Ollama API
- `create_annotation_node()`: 创建注释节点

---

### 6.3 终止 AI 请求 (NODE_OT_stop_ai_request)

**代码位置**：`__init__.py` 第 2816-2836 行

**功能**：终止当前正在进行的 AI 请求。

**行为**：
- 更新 `ai_question_status` 为 'STOPPED'
- 更新 `can_terminate_request` 为 False
- 更新 `current_status` 为 "请求已终止"

**相关属性**：
- `ai_question_status`
- `can_terminate_request`
- `current_status`

---

## 7. 快速复制运算符

### 7.1 复制文本部分 (NODE_OT_copy_text_part)

**代码位置**：`__init__.py` 第 939-983 行

**功能**：切换文本部分选择 / 复制单个部分。

**参数**：
- `part`: 文本部分名称

**行为**：
- 左键点击：切换选中状态
- Shift + 点击：直接复制该部分的文本内容

**文本部分映射**：
- `output_detail` → `01-输出详细程度提示词`
- `system_prompt` → `02-系统提示词`
- `user_question` → `03-用户问题`
- `node_data` → `04-节点数据`

---

### 7.2 复制选中文本 (NODE_OT_copy_active_text)

**代码位置**：`__init__.py` 第 986-991 行

**功能**：复制所有选中的文本部分到剪贴板。

**行为**：
- 遍历所有选中的文本部分
- 复制内容到剪贴板
- 使用格式：`=== part ===\n内容`

**相关属性**：
- `selected_text_parts`

---

## 8. 右键菜单运算符

### 8.1 AI 提问（右键菜单）(NODE_OT_ask_ai_context)

**代码位置**：`__init__.py` 第 4187-4337 行

**功能**：右键菜单 AI 提问操作符。

**参数**：
- `node_scope`: 节点范围（ALL/NONE/SELECTED）
- `question_type`: 问题类型（MANUAL/PRESET）
- `question_index`: 预设问题索引

**行为**：
- 根据节点范围选择要分析的节点
- 根据问题类型获取问题内容
- 执行 AI 分析

**节点范围**：
- `ALL`: 分析当前节点树中的所有节点
- `NONE`: 不传递任何节点信息，仅基于问题进行回答
- `SELECTED`: 仅分析当前选中的节点

**问题类型**：
- `MANUAL`: 手动输入问题
- `PRESET`: 从预设中获取问题

---

### 8.2 确认问题输入 (NODE_OT_confirm_question_input)

**代码位置**：`__init__.py` 第 4354-4368 行

**功能**：确认问题输入。

**行为**：
- 获取用户输入的问题
- 执行分析

---

### 8.3 取消问题输入 (NODE_OT_cancel_question_input)

**代码位置**：`__init__.py` 第 4371-4381 行

**功能**：取消问题输入。

**行为**：
- 更新状态为 IDLE
- 清空 `can_terminate_request`
- 更新 `current_status` 为 "就绪"

---

## 工具函数

### 节点解析函数

#### parse_node_tree_recursive(node_tree, depth=0, max_depth=10)

**代码位置**：`__init__.py` 第 899-1108 行

**功能**：递归解析节点树。

**参数**：
- `node_tree`: 要解析的节点树
- `depth`: 当前递归深度
- `max_depth`: 最大递归深度

**返回**：包含节点信息的字典

---

#### get_selected_nodes_description(context)

**代码位置**：`__init__.py` 第 1111-1309 行

**功能**：获取选中节点的描述。

**参数**：
- `context`: Blender 上下文

**返回**：包含节点描述的 JSON 字符串

---

### 过滤函数

#### filter_node_description(text, level)

**代码位置**：`__init__.py` 第 267-317 行

**功能**：过滤节点描述。

**参数**：
- `text`: 节点描述文本
- `level`: 过滤级别（ULTRA_LITE/LITE/STANDARD/FULL）

**返回**：过滤后的节点描述

---

### 其他工具函数

#### get_output_detail_instruction(settings)

**代码位置**：`__init__.py` 第 26-35 行

**功能**：获取输出详细程度指令。

---

#### clean_markdown(text)

**代码位置**：`__init__.py` 第 38-52 行

**功能**：清理 Markdown 格式。

---

#### copy_to_clipboard(text)

**代码位置**：`__init__.py` 第 55-62 行

**功能**：复制文本到剪贴板。

---

#### get_text_items(self, context)

**代码位置**：`__init__.py` 第 65-77 行

**功能**：获取文本块列表。

---

#### get_identity_items(self, context)

**代码位置**：`__init__.py` 第 80-92 行

**功能**：获取身份预设列表。

---

#### get_provider_items(self, context)

**代码位置**：`__init__.py` 第 95-107 行

**功能**：获取服务商列表。

---

#### get_default_question_items(self, context)

**代码位置**：`__init__.py` 第 133-145 行

**功能**：获取默认问题列表。

---

#### get_model_items(self, context)

**代码位置**：`__init__.py` 第 148-194 行

**功能**：获取模型列表。

---

#### get_response_detail_items(self, context)

**代码位置**：`__init__.py` 第 197-215 行

**功能**：获取回答精细度选项。

---

#### get_auto_identity_for_node_type(tree_type)

**代码位置**：`__init__.py` 第 218-247 行

**功能**：根据节点类型获取对应的身份预设。