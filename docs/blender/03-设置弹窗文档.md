# 设置弹窗文档 (AINodeAnalyzerSettingsPopup)

## 弹窗信息

| 属性 | 值 |
|------|-----|
| 类名 | `AINodeAnalyzerSettingsPopup` |
| 标签 | "AI节点分析器设置" |
| 类型 | `Operator` |
| 选项 | `{'REGISTER', 'INTERNAL'}` |

## 弹窗结构

设置弹窗分为多个区域：

1. **信息行** - 显示 Blender 版本、节点类型和当前模型
2. **AI 服务提供商设置**
3. **Tab 选择栏** - 身份 / 提示词 / 精细度控制
4. **记忆与思考功能**
5. **后端服务器设置**
6. **配置管理**

## 1. 信息行

### 功能说明

显示当前环境信息。

### 组件

| 组件 | 图标 | 功能 |
|------|------|------|
| Blender 版本 | `BLENDER` | 显示 Blender 版本号 |
| 节点类型 | 无 | 显示当前节点编辑器类型 |
| 当前模型 | 无 | 显示当前使用的 AI 模型 |

### 代码位置

`__init__.py` 第 1196-1224 行

```python
info_row = layout.row(align=True)
info_row.label(text=f"版本: {bpy.app.version_string}", icon='BLENDER')

node_type = "未知"
if context.space_data and hasattr(context.space_data, 'tree_type'):
    tree_type = context.space_data.tree_type
    if tree_type == 'GeometryNodeTree':
        node_type = "几何节点"
    elif tree_type == 'ShaderNodeTree':
        node_type = "材质节点"
    elif tree_type == 'CompositorNodeTree':
        node_type = "合成节点"
    elif tree_type == 'TextureNodeTree':
        node_type = "纹理节点"
    elif tree_type == 'WorldNodeTree':
        node_type = "环境节点"

info_row.label(text=f"类型: {node_type}")

current_model = ""
try:
    if ain_settings.ai_provider == 'DEEPSEEK':
        current_model = ain_settings.deepseek_model
    elif ain_settings.ai_provider == 'OLLAMA':
        current_model = ain_settings.ollama_model
    elif ain_settings.ai_provider == 'BIGMODEL':
        current_model = ain_settings.bigmodel_model
    else:
        current_model = ain_settings.generic_model
except:
    current_model = "未知"

info_row.label(text=f"模型: {current_model}")
```

## 2. AI 服务提供商设置

### 功能说明

配置 AI 服务提供商的连接信息。

### 组件

| 组件 | 图标 | 功能 |
|------|------|------|
| 服务商下拉菜单 | 无 | 选择 AI 服务提供商 |
| 服务地址输入框 | 无 | 输入服务地址 |
| 重置地址按钮 | `LOOP_BACK` | 重置服务地址为默认值 |
| API 密钥输入框 | 无 | 输入 API 密钥 |
| 清空密钥按钮 | `X` | 清空 API 密钥 |
| 模型输入框 | 无 | 输入模型名称 |
| 刷新模型按钮 | `FILE_REFRESH` | 刷新可用模型列表 |
| 测试模型按钮 | `CHECKMARK` | 测试 BigModel 模型 |
| 可用模型列表 | `LINENUMBERS_ON` | 显示可用模型列表 |
| 连通性状态 | `CHECKMARK` / `CANCEL` | 显示连通性状态 |
| 检测连通性按钮 | `INFO` | 测试服务商连通性 |

### 代码位置

`__init__.py` 第 1226-1318 行

```python
provider_box = layout.box()
provider_box.label(text="AI服务提供商设置", icon='WORLD_DATA')
provider_box.prop(ain_settings, "ai_provider")

# 地址和密钥行
addr_row = provider_box.row()
if ain_settings.ai_provider == 'DEEPSEEK':
    addr_row.prop(ain_settings, "deepseek_url", text="地址")
elif ain_settings.ai_provider == 'OLLAMA':
    addr_row.prop(ain_settings, "ollama_url", text="地址")
elif ain_settings.ai_provider == 'BIGMODEL':
    addr_row.prop(ain_settings, "bigmodel_url", text="地址")
else:
    addr_row.prop(ain_settings, "generic_base_url", text="地址")
addr_row.operator("node.reset_provider_url", text="", icon='LOOP_BACK')

key_row = provider_box.row()
if ain_settings.ai_provider == 'DEEPSEEK':
    key_row.prop(ain_settings, "deepseek_api_key", text="密钥")
elif ain_settings.ai_provider == 'OLLAMA':
    key_row.prop(ain_settings, "generic_api_key", text="密钥")
elif ain_settings.ai_provider == 'BIGMODEL':
    key_row.prop(ain_settings, "bigmodel_api_key", text="密钥")
else:
    key_row.prop(ain_settings, "generic_api_key", text="密钥")
clear_key_op = key_row.operator("node.clear_api_key", text="", icon='X')

# 模型行
model_row = provider_box.row()
if ain_settings.ai_provider == 'DEEPSEEK':
    model_row.prop(ain_settings, "deepseek_model", text="模型")
elif ain_settings.ai_provider == 'OLLAMA':
    model_row.prop(ain_settings, "ollama_model", text="模型")
elif ain_settings.ai_provider == 'BIGMODEL':
    model_row.prop(ain_settings, "bigmodel_model", text="模型")
else:
    model_row.prop(ain_settings, "generic_model", text="模型")
if server_manager and server_manager.is_running:
    model_row.operator("node.refresh_models", text="", icon='FILE_REFRESH')
    if ain_settings.ai_provider == 'BIGMODEL':
        model_row.operator("node.test_bigmodel_model", text="", icon='CHECKMARK')
else:
    model_row.operator("node.refresh_models_disabled", text="", icon='FILE_REFRESH')

# 显示可用模型列表
# ... (略)

# 状态信息和检测按钮
status_row = provider_box.row()
if server_manager and server_manager.is_running:
    if ain_settings.status_connectivity == "可用":
        status_row.label(text=f"连通性: {ain_settings.status_connectivity}", icon='CHECKMARK')
    else:
        status_row.label(text=f"连通性: {ain_settings.status_connectivity}", icon='CANCEL')
    status_row.operator("node.test_provider_status", text="检测连通性", icon='INFO')
else:
    status_row.label(text="后端未启动", icon='CANCEL')
    status_row = provider_box.row()
    status_row.label(text="请先启动后端服务器", icon='ERROR')
    status_row = provider_box.row()
    status_row.operator("node.test_provider_status_disabled", text="检测连通性", icon='INFO')
```

## 3. Tab 选择栏

### 功能说明

切换不同的设置面板。

### 组件

| Tab | 功能 |
|-----|------|
| 身份 | 身份预设设置 |
| 提示词 | 默认提示词设置 |
| 精细度 | 回答精细度控制设置 |

### 代码位置

`__init__.py` 第 1320-1324 行

```python
tab_row = layout.row()
tab_row.prop_enum(ain_settings, "current_tab", 'IDENTITY')
tab_row.prop_enum(ain_settings, "current_tab", 'PROMPTS')
tab_row.prop_enum(ain_settings, "current_tab", 'DETAIL')
```

## 3.1 身份设置面板

### 功能说明

配置 AI 身份预设。

### 组件

| 组件 | 图标 | 功能 |
|------|------|------|
| 身份预设下拉菜单 | 无 | 选择 AI 身份预设 |
| 系统提示词输入框 | `TEXT` | 输入系统提示词 |

### 代码位置

`__init__.py` 第 1326-1334 行

```python
if ain_settings.current_tab == 'IDENTITY':
    identity_box = layout.box()
    identity_box.label(text="身份设置", icon='TEXT')

    identity_subbox = identity_box.box()
    identity_subbox.prop(ain_settings, "identity_key", text="身份预设")
    identity_subbox.prop(ain_settings, "system_prompt", text="系统提示词")
```

## 3.2 提示词设置面板

### 功能说明

配置默认提示词。

### 组件

| 组件 | 功能 |
|------|------|
| 默认提示词下拉菜单 | 选择默认提示词预设 |
| 自定义问题输入框 | 输入自定义问题 |

### 代码位置

`__init__.py` 第 1336-1344 行

```python
elif ain_settings.current_tab == 'PROMPTS':
    prompt_box = layout.box()
    prompt_box.label(text="提示词设置", icon='TEXT')

    question_subbox = prompt_box.box()
    question_subbox.prop(ain_settings, "default_question_preset", text="默认提示词")
    question_subbox.prop(ain_settings, "default_question", text="自定义问题")
```

## 3.3 精细度控制面板

### 功能说明

配置回答精细度控制。

### 组件

| 组件 | 功能 |
|------|------|
| 回答精细度下拉菜单 | 选择回答精细度 |
| 对应提示词输入框 | 根据选择的精细度显示对应的提示词 |

### 代码位置

`__init__.py` 第 1346-1362 行

```python
elif ain_settings.current_tab == 'DETAIL':
    detail_box = layout.box()
    detail_box.label(text="精细度控制", icon='TEXT')

    detail_subbox = detail_box.box()
    detail_subbox.prop(ain_settings, "output_detail_level", text="回答精细度")

    if ain_settings.output_detail_level == 'simple':
        detail_subbox.prop(ain_settings, "prompt_simple", text="简约提示")
    elif ain_settings.output_detail_level == 'medium':
        detail_subbox.prop(ain_settings, "prompt_medium", text="适中提示")
    elif ain_settings.output_detail_level == 'detailed':
        detail_subbox.prop(ain_settings, "prompt_detailed", text="详细提示")
```

## 4. 记忆与思考功能

### 功能说明

配置记忆和思考功能。

### 组件

| 组件 | 功能 |
|------|------|
| 启用记忆复选框 | 启用/禁用对话记忆功能 |
| 记忆目标输入框 | 设置记忆目标值 |
| 深度思考复选框 | 启用/禁用深度思考模式 |
| 联网复选框 | 允许联网检索 |

### 代码位置

`__init__.py` 第 1364-1370 行

```python
memory_box = layout.box()
memory_box.label(text="记忆与思考", icon='MEMORY')
row = memory_box.row()
row.prop(ain_settings, "enable_memory")
row.prop(ain_settings, "memory_target_k")
row = memory_box.row()
row.prop(ain_settings, "enable_thinking")
row.prop(ain_settings, "enable_web")
```

## 5. 后端服务器设置

### 功能说明

配置后端服务器。

### 组件

| 组件 | 图标 | 功能 |
|------|------|------|
| 启动/停止按钮 | `PLAY` / `SNAP_FACE` | 启动或停止后端服务器 |
| 端口输入框 | 无 | 设置后端服务器端口 |

### 代码位置

`__init__.py` 第 1372-1378 行

```python
server_box = layout.box()
server_box.label(text="后端服务器设置", icon='WORLD_DATA')
server_row = server_box.row()
try:
    server_row.operator("node.toggle_backend_server", text="启动" if not (server_manager and server_manager.is_running) else "停止", icon='PLAY' if not (server_manager and server_manager.is_running) else 'SNAP_FACE')
except:
    server_row.operator("node.toggle_backend_server", text="启动", icon='PLAY')
server_row.prop(ain_settings, "backend_port", text="端口")
```

## 6. 配置管理

### 功能说明

管理配置文件。

### 组件

| 组件 | 图标 | 功能 |
|------|------|------|
| 重载配置按钮 | `FILE_REFRESH` | 从文件重新加载配置 |
| 保存配置按钮 | `FILE_TICK` | 保存当前配置到文件 |
| 重置默认按钮 | `LOOP_BACK` | 重置所有设置为默认值 |

### 代码位置

`__init__.py` 第 1380-1387 行

```python
config_box = layout.box()
config_box.label(text="配置管理", icon='FILE_TEXT')
config_row = config_box.row()
config_row.operator("node.load_config_from_file", text="重载配置", icon='FILE_REFRESH')
config_row.operator("node.save_config_to_file", text="保存配置", icon='FILE_TICK')
config_row.operator("node.reset_settings", text="重置默认", icon='LOOP_BACK')
```

## 相关运算符

| 运算符 | 功能 |
|--------|------|
| `node.reset_provider_url` | 重置服务地址 |
| `node.clear_api_key` | 清空 API 密钥 |
| `node.refresh_models` | 刷新模型列表 |
| `node.test_bigmodel_model` | 测试 BigModel 模型 |
| `node.test_provider_status` | 测试提供商连通性 |
| `node.toggle_backend_server` | 切换后端服务器 |
| `node.load_config_from_file` | 从文件加载配置 |
| `node.save_config_to_file` | 保存配置到文件 |
| `node.reset_settings` | 重置设置 |

## 相关属性

| 属性 | 类型 | 描述 |
|------|------|------|
| `ai_provider` | Enum | AI 服务提供商 |
| `deepseek_url` | String | DeepSeek 服务地址 |
| `deepseek_api_key` | String | DeepSeek API 密钥 |
| `deepseek_model` | String | DeepSeek 模型 |
| `ollama_url` | String | Ollama 服务地址 |
| `ollama_model` | String | Ollama 模型 |
| `bigmodel_url` | String | BigModel 服务地址 |
| `bigmodel_api_key` | String | BigModel API 密钥 |
| `bigmodel_model` | String | BigModel 模型 |
| `generic_base_url` | String | 通用服务地址 |
| `generic_api_key` | String | 通用 API 密钥 |
| `generic_model` | String | 通用模型 |
| `status_connectivity` | String | 连通性状态 |
| `identity_key` | Enum | 身份预设 |
| `system_prompt` | String | 系统提示词 |
| `default_question_preset` | Enum | 默认问题预设 |
| `default_question` | String | 自定义问题 |
| `output_detail_level` | Enum | 回答精细度 |
| `prompt_simple` | String | 简约提示 |
| `prompt_medium` | String | 适中提示 |
| `prompt_detailed` | String | 详细提示 |
| `enable_memory` | Bool | 启用记忆 |
| `memory_target_k` | Int | 记忆目标值 |
| `enable_thinking` | Bool | 启用深度思考 |
| `enable_web` | Bool | 允许联网 |
| `backend_port` | Int | 后端服务器端口 |
| `current_tab` | Enum | 当前选中的 tab |

## 使用说明

1. **配置 AI 服务商**：
   - 选择服务商
   - 输入服务地址和 API 密钥
   - 选择模型
   - 测试连通性

2. **设置身份**：
   - 在 "身份" tab 中选择预设
   - 或自定义系统提示词

3. **配置提示词**：
   - 在 "提示词" tab 中选择默认提示词
   - 或自定义问题

4. **调整精细度**：
   - 在 "精细度" tab 中选择回答精细度
   - 根据需要调整对应的提示词

5. **启用高级功能**：
   - 启用记忆功能以保持对话上下文
   - 启用深度思考模式以获得更详细的分析
   - 启用联网检索以获取最新信息

6. **管理配置**：
   - 保存当前配置到文件
   - 从文件重新加载配置
   - 重置为默认设置