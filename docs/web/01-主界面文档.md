# Web 主界面文档

## 页面信息

| 属性 | 值 |
|------|-----|
| 路径 | `/chat/:uuid?` |
| 名称 | Chat |
| 组件 | `src/views/chat/index.vue` |
| 类型 | Vue 3 单页应用 |

## 页面结构

主界面采用 Cherry Studio 风格的布局，包含以下主要区域：

1. **头部区域** - 显示标题、模型、设置等
2. **消息区域** - 显示对话消息
3. **输入区域** - 用户输入和操作按钮
4. **侧边栏** - 节点数据视图（可折叠）

## 组件依赖

```vue
<template>
  <ChatLayout>
    <Header />
    <div class="messages-container">
      <Message v-for="msg in messages" :key="msg.id" />
    </div>
    <div class="input-container">
      <!-- 输入框和按钮 -->
    </div>
  </ChatLayout>
</template>
```

## 核心功能

### 1. 聊天功能

#### 发送消息

**代码位置**：`src/views/chat/index.vue` 第 1-150 行

**功能**：
- 发送用户消息到 AI
- 接收流式响应
- 显示思考过程
- 支持多轮对话

**关键代码**：
```typescript
const prompt = ref<string>('')
const loading = ref<boolean>(false)
const { addChat, updateChat } = useChat()

async function handleSubmit() {
  if (!prompt.value || loading.value)
    return

  loading.value = true
  controller = new AbortController()

  // 添加用户消息
  addChat({
    uuid: +uuid,
    dateTime: new Date().toLocaleString(),
    text: prompt.value,
    inversion: true,
    error: false,
    conversationOptions: null,
    requestOptions: { prompt: prompt.value }
  })

  try {
    // 发送请求
    await fetchChatAPIProcess({
      prompt: prompt.value,
      signal: controller.signal,
      onDownloadProgress: handleProgress
    })
  }
  catch (error) {
    // 错误处理
  }
  finally {
    loading.value = false
    prompt.value = ''
  }
}
```

#### 流式响应

**代码位置**：`src/views/chat/index.vue` 第 151-300 行

**功能**：
- 接收 SSE 流式数据
- 实时更新消息内容
- 区分思考内容和回答内容

**关键代码**：
```typescript
function handleProgress(progressEvent: AxiosProgressEvent) {
  const xhr = progressEvent.event.target
  const { responseText } = xhr
  const lines = responseText.split('\n')

  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = line.slice(6)
      if (data === '[DONE]')
        break

      try {
        const parsed = JSON.parse(data)
        if (parsed.type === 'thinking') {
          // 更新思考内容
          updateChatSome(uuid, chatIndex, {
            thinking: (currentThinking || '') + parsed.content
          })
        }
        else if (parsed.type === 'chunk') {
          // 更新回答内容
          updateChatSome(uuid, chatIndex, {
            text: (currentText || '') + parsed.content
          })
        }
      }
      catch (error) {
        // 忽略解析错误
      }
    }
  }
}
```

### 2. Blender 节点集成

#### 节点数据同步

**代码位置**：`src/views/chat/index.vue` 第 301-450 行

**功能**：
- 从后端获取 Blender 节点数据
- 显示节点信息
- 支持节点数据刷新

**关键代码**：
```typescript
const nodeData = computed(() => chatStore.nodeData || {
  nodes: '',
  filename: 'Unknown',
  version: '',
  node_type: '',
  tokens: 0
})

async function refreshNodeData() {
  try {
    const { data } = await fetchBlenderData()
    chatStore.updateNodeData(data)
  }
  catch (error) {
    console.error('Failed to fetch node data:', error)
  }
}
```

#### 变量插入

**代码位置**：`src/views/chat/index.vue` 第 451-550 行

**功能**：
- 支持 `{{Current Node Data}}` 变量
- 拖拽插入变量
- 自动替换变量为实际节点数据

**关键代码**：
```typescript
const attachedVariables = ref<string[]>([])

function handleVariableDrop(variable: string) {
  if (!attachedVariables.value.includes(variable)) {
    attachedVariables.value.push(variable)
    prompt.value += ` {{${variable}}}`
  }
}

function replaceVariables(text: string): string {
  return text.replace(/\{\{Current Node Data\}\}/g, nodeData.value.nodes)
}
```

### 3. AI 配置

#### 输出详细程度

**代码位置**：`src/views/chat/index.vue` 第 551-650 行

**功能**：
- 三种输出模式：简约、适中、详细
- 循环切换模式
- 显示当前模式图标

**关键代码**：
```typescript
const outputDetailLevel = computed({
  get() {
    return settingStore.outputDetailLevel || 'medium'
  },
  set(value: 'simple' | 'medium' | 'detailed') {
    settingStore.updateSetting({ outputDetailLevel: value })
  }
})

const outputDetailOptions = [
  { label: '简约', value: 'simple', description: '简要说明，无格式' },
  { label: '适中', value: 'medium', description: '常规回答，使用markdown' },
  { label: '详细', value: 'detailed', description: '详细说明，使用图表等' }
]

const outputDetailLevelIcon = computed(() => {
  const iconMap: Record<string, string> = {
    'simple': 'ri:layout-bottom-line',
    'medium': 'ri:layout-column-line',
    'detailed': 'ri:layout-3-line'
  }
  return iconMap[outputDetailLevel.value] || 'ri:layout-bottom-line'
})

function cycleOutputDetailLevel() {
  const levels: Array<'simple' | 'medium' | 'detailed'> = ['simple', 'medium', 'detailed']
  const currentIndex = levels.indexOf(outputDetailLevel.value)
  const nextIndex = (currentIndex + 1) % levels.length
  outputDetailLevel.value = levels[nextIndex]
}
```

#### 深度思考模式

**代码位置**：`src/views/chat/index.vue` 第 651-700 行

**功能**：
- 启用/禁用深度思考
- 显示思考过程
- 支持多服务商

**关键代码**：
```typescript
const thinkingEnabled = computed<boolean>(() => !!(settingStore.ai?.thinking?.enabled))

function toggleThinkingMode() {
  settingStore.updateSetting({
    ai: {
      ...settingStore.ai,
      thinking: {
        enabled: !thinkingEnabled.value
      }
    }
  })
}
```

#### 联网搜索

**代码位置**：`src/views/chat/index.vue` 第 701-750 行

**功能**：
- 启用/禁用联网搜索
- 获取最新信息

**关键代码**：
```typescript
const webSearchEnabled = computed<boolean>(() => !!(settingStore.ai?.web_search?.enabled))

function toggleWebSearchMode() {
  settingStore.updateSetting({
    ai: {
      ...settingStore.ai,
      web_search: {
        enabled: !webSearchEnabled.value
      }
    }
  })
}
```

### 4. 对话管理

#### 对话历史

**代码位置**：`src/views/chat/index.vue` 第 751-850 行

**功能**：
- 显示对话历史
- 支持多轮对话
- 对话 ID 管理

**关键代码**：
```typescript
const dataSources = computed(() => chatStore.getChatByUuid(+uuid))
const conversationList = computed(() => 
  dataSources.value.filter(item => (!item.inversion && !!item.conversationOptions))
)

const currentConversationId = computed<string>(() => {
  const list = conversationList.value
  for (let i = list.length - 1; i >= 0; i--) {
    const cid = list[i].conversationOptions?.conversationId
    if (cid) return cid
  }
  return ''
})

const currentRounds = computed<number>(() => {
  const cid = currentConversationId.value
  if (!cid) return 0
  return conversationList.value.filter(it => it.conversationOptions?.conversationId === cid).length
})
```

#### 上下文使用

**代码位置**：`src/views/chat/index.vue` 第 851-900 行

**功能**：
- 启用/禁用上下文
- 控制对话轮数

**关键代码**：
```typescript
const { usingContext, toggleUsingContext } = useUsingContext()
```

### 5. 节点数据过滤

**代码位置**：`src/views/chat/index.vue` 第 901-1000 行

**功能**：
- 四种过滤级别：极简、简化、常规、完整
- 实时预览过滤结果
- 导出过滤后的数据

**关键代码**：
```typescript
const dataDetailLevel = ref(2) // 0=Ultra Lite, 1=Lite, 2=Standard, 3=Full

const dataDetailOptions = [
  { label: '极简', value: 0, description: '仅最小标识' },
  { label: '简化', value: 1, description: '保留必要的 IO' },
  { label: '常规', value: 2, description: '清除可视属性' },
  { label: '完整', value: 3, description: '完整上下文' }
]

function filterNodeData(data: string, level: number): string {
  // 实现过滤逻辑
  return filteredData
}
```

### 6. 导出功能

**代码位置**：`src/views/chat/index.vue` 第 1001-1100 行

**功能**：
- 导出对话为图片
- 导出节点数据
- 复制到剪贴板

**关键代码**：
```typescript
async function exportAsImage() {
  const element = document.querySelector('.messages-container')
  if (!element)
    return

  try {
    const dataUrl = await toPng(element)
    const link = document.createElement('a')
    link.download = `chat-${Date.now()}.png`
    link.href = dataUrl
    link.click()
  }
  catch (error) {
    console.error('Export failed:', error)
  }
}

function copyToClipboard() {
  const text = dataSources.value.map(msg => msg.text).join('\n\n')
  copyToClip(text)
}
```

## 布局结构

### Cherry Studio 风格布局

```
┌─────────────────────────────────────────────────────────┐
│ Header                                                  │
│ [图标组] [输入框] [按钮组]                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Messages                                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │ User: 问题                                       │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ AI: 回答                                        │   │
│  │ [思考] [内容]                                    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ Input                                                   │
│ [图标组] [输入框] [按钮组]                              │
└─────────────────────────────────────────────────────────┘
```

### 图标组（左侧）

| 图标 | 功能 |
|------|------|
| `ri:delete-bin-line` | 清空对话 |
| `ri:download-2-line` | 导出对话 |
| `ri:refresh-line` | 刷新节点数据 |
| `ri:chat-history-line` | 上下文开关 |
| `ri:brain-line` | 深度思考开关 |
| `ri:search-line` | 联网搜索开关 |
| `ri:stack-line` | 模型选择 |
| `ri:refresh-line` | 节点上下文 |

### 按钮组（右侧）

| 图标 | 功能 |
|------|------|
| 输出详细程度图标 | 循环切换输出模式 |
| `ri:send-plane-fill` | 发送消息 |

## 状态管理

### 响应式变量

| 变量 | 类型 | 描述 |
|------|------|------|
| `prompt` | `Ref<string>` | 用户输入 |
| `loading` | `Ref<boolean>` | 加载状态 |
| `attachedVariables` | `Ref<string[]>` | 附加变量 |
| `dataDetailLevel` | `Ref<number>` | 数据详细程度 |
| `nodeData` | `Computed` | 节点数据 |
| `thinkingEnabled` | `Computed` | 深度思考启用 |
| `webSearchEnabled` | `Computed` | 联网搜索启用 |
| `nodeContextActive` | `Computed` | 节点上下文激活 |
| `outputDetailLevel` | `Computed` | 输出详细程度 |
| `currentConversationId` | `Computed` | 当前对话 ID |
| `currentRounds` | `Computed` | 当前对话轮数 |

### Store 依赖

| Store | 用途 |
|-------|------|
| `appStore` | 应用状态 |
| `chatStore` | 聊天状态 |
| `settingStore` | 设置状态 |
| `userStore` | 用户状态 |

## Hooks 使用

| Hook | 用途 |
|------|------|
| `useBasicLayout` | 基础布局 |
| `useScroll` | 滚动管理 |
| `useChat` | 聊天逻辑 |
| `useUsingContext` | 上下文逻辑 |

## 事件处理

| 事件 | 处理函数 |
|------|----------|
| `submit` | `handleSubmit` |
| `stop` | `handleStop` |
| `clear` | `handleClear` |
| `export` | `exportAsImage` |
| `copy` | `copyToClipboard` |
| `refresh` | `refreshNodeData` |
| `variable-drop` | `handleVariableDrop` |

## 样式说明

### Tailwind CSS 类

| 类 | 用途 |
|-----|------|
| `flex items-center gap-2` | 水平布局，间距 |
| `flex-1` | 占据剩余空间 |
| `shrink-0` | 不收缩 |
| `text-gray-500` | 灰色文本 |
| `hover:text-green-500` | 悬停绿色 |
| `transition-colors` | 颜色过渡 |
| `!bg-green-600` | 绿色背景 |
| `hover:!bg-green-700` | 悬停深绿色 |

### Less 样式

```less
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}

.input-container {
  border-top: 1px solid #e5e7eb;
  padding: 1rem;
}
```

## 响应式设计

| 断点 | 描述 |
|------|------|
| `md` | 中等屏幕（768px+） |
| `lg` | 大屏幕（1024px+） |
| `xl` | 超大屏幕（1280px+） |

## 可访问性

| 功能 | 实现 |
|------|------|
| 键盘导航 | 支持 Tab 键导航 |
| ARIA 标签 | 使用语义化 HTML |
| 焦点管理 | 自动聚焦输入框 |
| 屏幕阅读器 | 支持屏幕阅读器 |

## 性能优化

| 技术 | 用途 |
|------|------|
| 虚拟滚动 | 处理大量消息 |
| 懒加载 | 按需加载组件 |
| 防抖/节流 | 优化事件处理 |
| 缓存 | 缓存节点数据 |