# Blender MCP 协议集成项目总览

**文档版本**: 1.0.0
**创建日期**: 2026-01-13
**状态**: 待开始

---

## 1. 项目目标

在不破坏现有 Web 通信逻辑、不修改已有过滤算法的前提下，为后端增加 **MCP (Model Context Protocol)** 支持。实现 **Web、Blender、MCP 三端共享同一套数据读取与过滤逻辑**。

## 2. 核心需求

### 2.1 功能需求

1. **资产检索**: 遍历 `bpy.data`，返回包含几何节点组、材质、合成、世界环境的路径化树状图
2. **模块定位**: 根据路径字符串精准定位 Blender 内部的数据块 (Data-Block)
3. **独立过滤**: 将现有的"过滤节点信息"功能封装为独立模块
4. **配置读取**: 根据 config.json 返回对应的专家背景和详略要求文本
5. **节点解析**: 将现有的 `parse_node_tree_recursive` 函数封装为独立模块

### 2.2 技术需求

1. **零副作用**: MCP 的运行不得阻塞 Blender UI 或干扰现有的 Web 接口响应
2. **协议标准**: 严格遵守 Model Context Protocol 规范（JSON-RPC 2.0）
3. **代码复用**: 三端共享同一套数据读取与过滤逻辑
4. **向后兼容**: 保持现有功能完全不变
5. **线程安全**: MCP 线程对 Blender API 的调用必须在主线程安全执行

## 3. 架构设计

### 3.1 三端架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Web 端    │     │  Blender端  │     │   MCP 端    │
│  (Vue.js)   │     │  (插件)     │     │  (MCP协议)  │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                   ┌───────▼───────┐
                   │  统一后端层    │
                   │  (Flask)      │
                   └───────┬───────┘
                           │
                   ┌───────▼───────────────┐
                   │   核心功能模块层       │
                   │  (原子化功能)         │
                   └───────────────────────┘
```

### 3.2 模块划分

```
backend/
├── core/                   # 核心功能模块（原子化）
│   ├── hierarchy.py        # 资产检索
│   ├── module_fetcher.py   # 模块定位
│   ├── node_filter.py      # 节点过滤
│   ├── node_parser.py      # 节点解析
│   └── config_reader.py    # 配置读取
├── mcp/                    # MCP 服务器模块
│   ├── server.py           # MCP 服务器
│   ├── tools.py            # MCP 工具定义
│   ├── task_queue.py       # 任务队列管理
│   └── config_generator.py # 配置生成器
└── server.py               # Flask 后端服务器
```

## 4. 开发阶段

### 阶段一：现有功能"原子化"抽象

将现有功能重构为独立的、可复用的模块：

1. **资产检索模块** (`get_hierarchy`)
2. **模块定位模块** (`fetch_module`)
3. **节点过滤模块** (`filter_node_data`)
4. **节点解析模块** (`parse_node_tree`)
5. **配置读取模块** (`get_config`)

**预计时间**: 2-3 天

### 阶段二：MCP 适配器实现

实现 MCP 协议支持和服务器：

1. **任务队列管理** - 基于 `bpy.app.timers` 的异步执行
2. **MCP 服务器** - 支持 SSE 和 JSON-RPC 2.0
3. **MCP 工具定义** - 注册 5 个核心工具
4. **多协议监听** - 在 5000 端口新增 `/mcp/sse` 和 `/mcp/rpc` 路由

**预计时间**: 3-4 天

### 阶段三：测试面板与诊断系统

在 Blender UI 中添加测试和诊断功能：

1. **MCP 诊断面板** - 显示服务器状态和测试结果
2. **功能校验按钮** - 测试各个模块功能
3. **配置导出** - 生成 `mcp_config.json` 模板

**预计时间**: 1-2 天

### 阶段四：文档与集成测试

完成文档编写和全面测试：

1. **编写文档** - MCP 开发文档、API 文档、使用指南
2. **集成测试** - 测试三端交互
3. **性能测试** - 测试服务器性能
4. **最终验证** - 验证所有需求

**预计时间**: 1 天

**总预计时间**: 7-10 天

## 5. MCP 工具列表

| 工具名称 | 描述 | 输入参数 | 输出 |
|----------|------|----------|------|
| `get_full_tree` | 获取全局资产路径 | `include_*` 参数 | 资产层级结构 |
| `inspect_module` | 定位模块并提取数据 | `path`, `filter_level` | 过滤后的节点数据 |
| `get_config` | 读取配置 | `config_key` | 配置数据 |
| `parse_node_tree` | 解析节点树 | `node_tree`, `max_depth` | 解析后的节点树 |
| `filter_node_data` | 过滤节点数据 | `raw_data`, `filter_level` | 过滤后的数据 |

## 6. 技术约束

### 6.1 代码风格

- 遵循 PEP 8 规范
- 所有函数必须包含异常处理
- 所有公共函数必须包含文档字符串
- 使用 Python 类型提示

### 6.2 线程安全

- 所有 Blender API 调用必须在主线程执行
- 使用 `bpy.app.timers` 实现任务队列
- 使用 `threading.Lock` 保护共享资源
- 所有异步操作必须有超时机制

### 6.3 向后兼容

- 不得修改现有功能的 API
- 保持 `config.json` 格式不变
- 新增路由不得与现有路由冲突
- 新增全局变量必须命名清晰

## 7. 预期产出

### 7.1 代码产出

1. **核心功能模块** - 5 个原子化模块
2. **MCP 服务器模块** - 4 个 MCP 相关模块
3. **Blender UI 增强** - 新增面板和运算符
4. **配置文件** - `mcp_config.json` 模板

### 7.2 文档产出

1. **MCP 开发文档** - 详细的开发指南
2. **API 文档** - MCP 工具 API 文档
3. **使用指南** - 如何使用 MCP 功能
4. **测试文档** - 测试计划和结果

## 8. 验收标准

### 8.1 功能验收

- ✅ 所有 MCP 工具正常工作
- ✅ 任务队列正确执行
- ✅ SSE 连接稳定
- ✅ JSON-RPC 请求正确处理
- ✅ 测试面板功能正常
- ✅ 配置导出功能正常

### 8.2 性能验收

- ✅ MCP 服务器响应时间 < 100ms
- ✅ 任务队列执行时间 < 1s
- ✅ 内存占用 < 100MB
- ✅ CPU 占用 < 10%

### 8.3 兼容性验收

- ✅ 现有 Web 功能不受影响
- ✅ 现有 Blender 功能不受影响
- ✅ 配置文件格式保持兼容
- ✅ API 接口保持兼容

## 9. 相关文档

- [阶段一：功能原子化](./01-阶段一_功能原子化.md)
- [阶段二：MCP适配器实现](./02-阶段二_MCP适配器实现.md)
- [阶段三：测试面板与诊断系统](./03-阶段三_测试面板与诊断系统.md)
- [技术规范与验收标准](./04-技术规范与验收标准.md)

---

**文档结束**